drop table if exists `users`;
CREATE TABLE `users` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
  `open_id` varchar(50) NOT NULL DEFAULT '' COMMENT '用户openId',
  `user_no` varchar(100) not null comment '用户no',
  `name` varchar(200) NOT NULL COMMENT '用户名称',
  `head_url` varchar(500) NOT NULL DEFAULT '' COMMENT '用户头像',
  `sex` char(1) NOT NULL DEFAULT '' COMMENT '用户性别 w 女 m 男 x 未知',
  `mobile` varchar(20) NOT NULL DEFAULT '' COMMENT '用户手机号',
  `created_at` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `updated_at` timestamp NULL DEFAULT NULL COMMENT '修改时间',
  `status` int NOT NULL DEFAULT '0' COMMENT '用户状态',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除',
  `role` int DEFAULT '0',
  PRIMARY KEY (`id`),
  KEY `idx_users_created_at` (`created_at`),
  KEY `idx_users_updated_at` (`updated_at`),
  KEY `idx_mobile` (`mobile`),
  KEY `idx_users_open_id` (`open_id`),
  KEY `idx_users_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户信息';

drop table if exists `room_info`;
CREATE TABLE `room_info`
(
    `id`         int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
    `name`       varchar(100)     NOT NULL DEFAULT '' COMMENT '房间名字',
    `is_private` int(1)           NOT NULL default 0 COMMENT '是否公开 0 公开 1加密',
    `password`   varchar(10)      NOT NULL DEFAULT '' COMMENT '密码',
    `creator`    int(10)          NOT NULL COMMENT '创建用户',
    `room_no`    varchar(100)      NOT NULL COMMENT '房间唯一标识',
    `icon`    varchar(100)      NOT NULL COMMENT '图标',
    `is_chorus`  int(1)           NOT NULL default 0 COMMENT '是否合唱 0 不合唱 1合唱',
    `bg_option`  varchar(200)           NOT NULL default '' COMMENT '背景',
    `sound_effect`  varchar(200)           NOT NULL default '' COMMENT '音效',
    `bel_canto`  varchar(200)           NOT NULL default '' COMMENT '美声',
    `created_at` timestamp        NULL     DEFAULT NULL COMMENT '创建时间',
    `updated_at` timestamp        NULL     DEFAULT NULL COMMENT '修改时间',
    `status`     int(1)           NOT NULL DEFAULT 0 COMMENT '房间状态 0 正常 1关闭 2异常',
    `deleted_at` timestamp        NULL     DEFAULT null COMMENT '删除',
    PRIMARY KEY (`id`),
    KEY `idx_room_created_at` (`created_at`),
    KEY `idx_room_updated_at` (`updated_at`),
    KEY `idx_room_creator` (`creator`),
    KEY `idx_room_room_no` (`room_no`),
    KEY `idx_room_name` (`name`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT ='房间信息';

drop table if exists `room_song`;
CREATE TABLE `room_song`
(
    `id`          int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
    `room_no`     varchar(100)      NOT NULL COMMENT '房间唯一标识',
    `song_no`     varchar(100)     NOT NULL COMMENT '歌曲',
    `sort`        int(5)           NOT NULL COMMENT '排序',
     `user_no` varchar(100) not null comment '用户no',
     `chorus_no` varchar(100) not null comment '合唱者',
    `is_original` int(1)           NOT NULL default 0 COMMENT '是否是原唱 0 不是 1 原唱',
    `is_chorus`  int(1)           NOT NULL default 0 COMMENT '是否合唱 0 不合唱 1合唱',
    `is_switch`   varchar(100)     NOT NULL default '0' COMMENT '是否切歌了 0 没切 1切了',
    `score`       int(3)           null COMMENT '得分',
    `created_at`  timestamp        NULL     DEFAULT NULL COMMENT '创建时间',
    `updated_at`  timestamp        NULL     DEFAULT NULL COMMENT '修改时间',
    `status`      int(1)           NOT NULL DEFAULT 0 COMMENT '1已唱 0 未唱',
    `deleted_at`  timestamp        NULL     DEFAULT null COMMENT '删除',
    PRIMARY KEY (`id`),
    KEY `idx_room_song_created_at` (`created_at`),
    KEY `idx_room_song_updated_at` (`updated_at`),
    KEY `idx_room_song_room_no` (`room_no`),
    KEY `idx_room_song_song_no` (`song_no`),
    KEY `idx_room_song_user_no` (`user_no`),
    KEY `idx_room_song_chorus_no` (`chorus_no`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT ='房间歌曲';

drop table if exists `room_song_users`;
CREATE TABLE `room_song_users`
(
    `id`           int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
    `room_no`      varchar(100)      NOT NULL COMMENT '房间唯一标识',
    `room_song_id` int(10)          NOT NULL COMMENT '歌曲id',
    `user_id`      int(10)          NOT NULL COMMENT '用户id',
    `score`        int(3)           NOT NULL default 0 COMMENT '得分',
    `created_at`   timestamp        NULL     DEFAULT NULL COMMENT '创建时间',
    `updated_at`   timestamp        NULL     DEFAULT NULL COMMENT '修改时间',
    `status`       int(1)           NOT NULL DEFAULT 0 COMMENT '1已唱 0 未唱',
    `deleted_at`   timestamp        NULL     DEFAULT null COMMENT '删除',
    PRIMARY KEY (`id`),
    KEY `idx_room_song_created_at` (`created_at`),
    KEY `idx_room_song_updated_at` (`updated_at`),
    KEY `idx_room_song_room_no` (`room_no`),
    KEY `idx_room_song_user_id` (`user_id`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT ='房间歌曲演唱者';

drop table if exists `songs`;
CREATE TABLE `songs`
(
    `id`          int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
    `song_no`     varchar(100)     NOT NULL COMMENT '歌曲',
    `song_name`     varchar(100)     NOT NULL COMMENT '歌曲名称',
    `song_url`     varchar(500)     NOT NULL COMMENT '歌曲',
    `image_url`     varchar(500)     NOT NULL COMMENT '歌曲图片',
    `singer`     varchar(100)     NOT NULL COMMENT '作者',
    `type`     varchar(10)     NOT NULL COMMENT '分类',
    `lyric`     varchar(500)     NOT NULL COMMENT '歌词',
    `created_at`  timestamp        NULL     DEFAULT NULL COMMENT '创建时间',
    `updated_at`  timestamp        NULL     DEFAULT NULL COMMENT '修改时间',
    `status`      int(1)           NOT NULL DEFAULT 0 COMMENT '1已唱 0 未唱',
    `deleted_at`  timestamp        NULL     DEFAULT null COMMENT '删除',
    PRIMARY KEY (`id`),
    KEY `idx_songs_created_at` (`created_at`),
    KEY `idx_songs_updated_at` (`updated_at`),
    KEY `idx_songs_song_no` (`song_no`),
    KEY `idx_songs_song_name` (`song_name`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT ='歌曲信息';

drop table if exists `room_users`;
CREATE TABLE `room_users` (
    `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
    `room_no` varchar(100) NOT NULL COMMENT '房间唯一标识',
    `user_id` int NOT NULL COMMENT '用户id',
    `on_seat` int NOT NULL COMMENT '是否上麦 0 未上 1-8 在麦上的位置',
    `join_sing` int NOT NULL default  0 COMMENT '是否合唱 0 不合唱 1合唱',
    `is_video_muted` int NOT NULL default 0 COMMENT '是否开启摄像头 0 不合唱 1合唱',
    `is_self_muted` int NOT NULL default 0 COMMENT '是否静音 0 不合唱 1合唱',
    `created_at` timestamp NULL DEFAULT NULL COMMENT '创建时间',
    `updated_at` timestamp NULL DEFAULT NULL COMMENT '修改时间',
    `status` int NOT NULL DEFAULT '0',
    `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除',
    PRIMARY KEY (`id`),
    KEY `idx_room_users_created_at` (`created_at`),
    KEY `idx_room_users_updated_at` (`updated_at`),
    KEY `idx_room_users_user_id` (`user_id`),
    KEY `idx_room_users_room_no` (`room_no`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='房间用户';

drop table if exists `verify_log`;
CREATE TABLE `verify_log`
(
    `id`         int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
    `user_no`    varchar(100)     not null comment '用户no',
    `reason`     varchar(100)     not null comment '原因',
    `result`     varchar(4000)    not null comment '返回json',
    `text`       varchar(4000)    not null comment '文本',
    `created_at` timestamp        NULL DEFAULT NULL COMMENT '创建时间',
    `updated_at` timestamp        NULL DEFAULT NULL COMMENT '修改时间',
    `status`     int(1)           NOT NULL DEFAULT 0 COMMENT '状态',
    PRIMARY KEY (`id`),
    KEY `idx_verify_log_created_at` (`created_at`),
    KEY `idx_verify_log_updated_at` (`updated_at`),
    KEY `idx_verify_log_user_no` (`user_no`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT ='审核日志';


drop table if exists `user_device_info`;
CREATE TABLE `user_device_info`
(
    `id`         int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
    `user_no`    varchar(100)     NOT NULL COMMENT '用户no',
    `mobile`     varchar(20)  NOT NULL DEFAULT '' COMMENT '用户手机号',
    `app_id`     varchar(100) NOT NULL DEFAULT '' COMMENT 'appId',
    `project_id` varchar(100) NOT NULL DEFAULT '' COMMENT '项目Id',
    `scene_id`    varchar(100) NOT NULL DEFAULT '' COMMENT '场景',
    `app_version` varchar(100) NOT NULL DEFAULT '' COMMENT 'App 版本号',
    `os_version` varchar(100) NOT NULL DEFAULT '' COMMENT 'os 版本号',
    `platform`    varchar(100) NOT NULL DEFAULT '' COMMENT 'os 平台',
    `model`     varchar(100) NOT NULL DEFAULT '' COMMENT '设备型号',
    `manufacture` varchar(100) NOT NULL DEFAULT '' COMMENT '制造商',
    `created_at` timestamp        NULL DEFAULT NULL COMMENT '创建时间',
    `updated_at` timestamp        NULL DEFAULT NULL COMMENT '修改时间',
    PRIMARY KEY (`id`),
    KEY `idx_device_info_created_at` (`created_at`),
    KEY `idx_device_info_updated_at` (`updated_at`),
    KEY `idx_device_info_user_no` (`user_no`),
    KEY `idx_device_info_user_mobile` (`mobile`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT ='用户设备';

drop table if exists `user_config`;
CREATE TABLE `user_config`
(
    `id`         int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
    `user_no`    varchar(100)     NOT NULL COMMENT '用户no',
    `mobile`     varchar(20)  NOT NULL DEFAULT '' COMMENT '用户手机号',
    `app_id`     varchar(100) NOT NULL DEFAULT '' COMMENT 'appId',
    `project_id` varchar(100) NOT NULL DEFAULT '' COMMENT '项目Id',
    `scene_id`    varchar(100) NOT NULL DEFAULT '' COMMENT '场景',
    `background_url` varchar(500) NOT NULL DEFAULT '' COMMENT '最近的一次App背景图片',
    `background_count`      int(10 NOT NULL DEFAULT 0 COMMENT '收集用户背景图片次数',
    `created_at` timestamp        NULL DEFAULT NULL COMMENT '创建时间',
    `updated_at` timestamp        NULL DEFAULT NULL COMMENT '修改时间',
    PRIMARY KEY (`id`),
    KEY `idx_user_config_created_at` (`created_at`),
    KEY `idx_user_config_updated_at` (`updated_at`),
    KEY `idx_user_config_user_no` (`user_no`),
    KEY `idx_user_config_user_mobile` (`mobile`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT ='用户配置信息';

ALTER TABLE `user_config` ADD UNIQUE KEY `user_config_unique` (`user_no`,`app_id`,`project_id`,`scene_id`);

drop table if exists `user_action_info`;
CREATE TABLE `user_action_info`
(
    `id`         int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id',
    `user_no`    varchar(100)     NOT NULL COMMENT '用户no',
    `mobile`     varchar(20)  NOT NULL DEFAULT '' COMMENT '用户手机号',
    `app_id`     varchar(100) NOT NULL DEFAULT '' COMMENT 'appId',
    `project_id` varchar(100) NOT NULL DEFAULT '' COMMENT '项目Id',
    `scene_id`    varchar(100) NOT NULL DEFAULT '' COMMENT '场景',
    `day` varchar(20) NOT NULL DEFAULT '' COMMENT '日期，精确到天'
    `action`     varchar(100) NOT NULL DEFAULT '' COMMENT '用户行为',
    `count`      int(10)          NOT NULL  DEFAULT 0 COMMENT '用户行为次数',
    `created_at` timestamp        NULL DEFAULT NULL COMMENT '创建时间',
    `updated_at` timestamp        NULL DEFAULT NULL COMMENT '修改时间',
    PRIMARY KEY (`id`),
    KEY `idx_user_action_info_created_at` (`created_at`),
    KEY `idx_user_action_info_updated_at` (`updated_at`),
    KEY `idx_user_action_info_user_no` (`user_no`),
    KEY `idx_user_action_info_user_mobile` (`mobile`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT ='用户行为统计信息';

ALTER TABLE `user_action_info` ADD UNIQUE KEY `user_action_unique` (`user_no`,`mobile`, `app_id`,`project_id`,`scene_id`,`action`,`day`);


# voice room
drop table if exists user_third_account;
create table user_third_account
(
    `id`         int(10) unsigned not null auto_increment comment 'id',
    `uid`        varchar(100)     not null comment '用户唯一标识',
    `chat_id`    varchar(128)     not null comment '用户对应在环信的用户id',
    `chat_uuid`  varchar(64)      not null comment '用户对应在的环信用户uuid',
    `rtc_uid`    int(32)                   comment 'rtc uid',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uniq_user_third_account_uid` (`uid`)
) engine = InnoDB default charset = utf8mb4 comment ='用户与三方系统的关联信息';

drop table if exists voice_room;
create table voice_room
(
    `id`                    int(10) unsigned not null auto_increment comment 'id',
    `room_id`               varchar(100)     not null comment '房间唯一标识',
    `chatroom_id`           bigint           not null comment '环信关联房间id',
    `channel_id`            varchar(128)     not null comment '声网RTC关联的channelId',
    `name`                  varchar(100)     NOT NULL DEFAULT '' COMMENT '房间名字',
    `is_private`            bool             NOT NULL default true COMMENT '是否公开 0 公开 1加密',
    `password`              varchar(100)     NULL DEFAULT '' COMMENT '密码',
    `allowed_free_join_mic` bool             not null default true comment '是否允许自由上麦',
    `type`                  int(2)           not null comment '房间类型',
    `owner`                 varchar(100)     not null comment '房主uid',
    `sound_effect`          varchar(256)     null comment '房间音效',
    `announcement`          varchar(256) comment '房间公告',
    `use_robot`             bool             not null default false comment '房间是否使用机器人',
    `mic_count`             int(4)           not null default 6 comment '房间麦位数量',
    `robot_count`           int(4)           not null default 2 comment '房间机器人数量',
    `robot_volume`          int(10)      default 50                   not null comment '房间机器人音量',
    `created_at`            timestamp(3)              default CURRENT_timestamp(3) not null comment '创建时间',
    `updated_at`            timestamp(3)              default CURRENT_timestamp(3) not null on update CURRENT_timestamp(3) comment '最近修改时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uniq_voice_room_room_id` (`room_id`),
    KEY `idx_voice_room_created_at` (`created_at`)
) engine = InnoDB
  default charset = utf8mb4 comment ='语聊房信息';

drop table if exists mic_apply_user;
create table mic_apply_user
(
    `id`         int(10) unsigned not null auto_increment comment 'id',
    `room_id`    varchar(100)     not null comment '房间唯一标识',
    `uid`        varchar(100)     not null comment '用户唯一标识',
    `mic_index`  int(4) comment '申请麦位位置',
    `created_at` timestamp(3)              default CURRENT_timestamp(3) not null comment '创建时间',
    `updated_at` timestamp(3)              default CURRENT_timestamp(3) not null on update CURRENT_timestamp(3) comment '最近修改时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uniq_voice_room_room_id_uid` (`room_id`, `uid`),
    KEY `idx_voice_room_created_at` (`created_at`)
) engine=InnoDB default charset=utf8mb4 comment='麦位申请信息';

drop table if exists gift_record;
create table gift_record
(
    `id`         int(10) unsigned not null auto_increment comment 'id',
    `room_id`    varchar(100)     not null comment '房间唯一标识',
    `uid`        varchar(100)     not null comment '送礼物用户唯一标识',
    `to_uid`     varchar(100)     not null comment '收礼物用户唯一标识',
    `amount`     bigint(10)       not null default 0 comment '贡献值',
    `created_at` timestamp(3)              default CURRENT_timestamp(3) not null comment '创建时间',
    `updated_at` timestamp(3)              default CURRENT_timestamp(3) not null on update CURRENT_timestamp(3) comment '最近修改时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uniq_voice_room_room_id_uid_to_uid` (`room_id`, `uid`, `to_uid`),
    KEY `idx_voice_room_amount` (`amount`)
) engine = InnoDB default charset = utf8mb4 comment ='打赏信息';

drop table if exists `user`;
create table `user`
(
    `id`        int(10) unsigned not null auto_increment comment 'id',
    `uid`       varchar(100)     not null comment '用户唯一标识',
    `name`      varchar(100)     not null comment '昵称',
    `portrait`  varchar(100)     not null comment '头像',
    `device_id` varchar(100)     not null comment '设备id',
    `phone`     varchar(20) comment '手机号',
    `created_at`            timestamp(3)              default CURRENT_timestamp(3) not null comment '创建时间',
    `updated_at`            timestamp(3)              default CURRENT_timestamp(3) not null on update CURRENT_timestamp(3) comment '最近修改时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uniq_user_uid` (`uid`),
    KEY `idx_user_device_id` (`device_id`),
    KEY `idx_user_phone` (`phone`)
) engine = InnoDB default charset = utf8mb4 comment ='用户信息';

drop table if exists `voice_room_user`;
create table `voice_room_user`
(
    `id`        int(10) unsigned not null auto_increment comment 'id',
    `room_id`      varchar(100)     not null comment '房间唯一标识',
    `uid`       varchar(100)     not null comment '用户唯一标识',
    `mic_index` int(4) not null default -1 comment '房间用户麦位信息 -1:没有在麦上，其余标识所在的麦位位置',
    `created_at`            timestamp(3)              default CURRENT_timestamp(3) not null comment '创建时间',
    `updated_at`            timestamp(3)              default CURRENT_timestamp(3) not null on update CURRENT_timestamp(3) comment '最近修改时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uniq_voice_room_user_room_id_uid` (`room_id`, `uid`)
) engine = InnoDB default charset = utf8mb4 comment ='房间用户信息';
